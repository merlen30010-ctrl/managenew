# 物料进出模块附件功能说明文档

## 1. 功能概述

物料进出模块附件功能允许用户为物料进出记录上传、下载和管理相关文件，如检验报告、交接单、运输单据等。该功能支持多种文件格式，并提供完整的权限控制和操作管理。

## 2. 数据结构

### 2.1 Attachment 模型

附件功能使用通用的 Attachment 模型，该模型可关联到不同类型的业务实体。在物料进出模块中，附件关联到 MaterialTransaction 实体。

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| id | Integer | 主键ID |
| related_type | String | 关联类型，固定为 'material_transaction' |
| related_id | Integer | 关联的物料进出记录ID |
| file_path | String | 文件存储路径 |
| original_name | String | 原始文件名 |
| file_type | String | 文件类型 |
| file_size | Integer | 文件大小（字节） |
| description | String | 文件描述 |
| created_by | Integer | 上传人ID |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

## 3. 业务逻辑

### 3.1 文件存储

- 文件存储在服务器的 `uploads/material_transaction/YYYYMM/` 目录下，按年月组织
- 文件名使用安全处理并生成唯一标识，防止文件名冲突和路径遍历攻击
- 系统记录原始文件名，以便用户下载时显示正确的文件名

### 3.2 权限控制

附件功能的权限控制遵循以下规则：

- 上传附件：需要 `material_transaction_update` 权限
- 下载附件：需要 `material_transaction_read` 权限
- 删除附件：需要 `material_transaction_update` 权限

对于没有全局权限的用户，只能操作其负责工厂的物料进出记录附件：

- 没有 `material_transaction_update_all` 权限的用户，只能为其负责工厂的记录上传和删除附件
- 没有 `material_transaction_read_all` 权限的用户，只能下载其负责工厂的记录附件

## 4. API接口文档

### 4.1 上传附件

```
POST /api/material-transactions/<transaction_id>/attachments
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_update` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_id | Integer | 是 | 物料进出记录ID，路径参数 |
| file | File | 是 | 上传的文件，表单数据 |
| description | String | 否 | 文件描述，表单数据 |

#### 响应结果

```json
{
  "id": 1,
  "file_path": "material_transaction/202301/filename.pdf",
  "original_name": "report.pdf",
  "file_type": "pdf",
  "file_size": 1024,
  "description": "检验报告",
  "created_at": "2023-01-01T08:00:00Z"
}
```

### 4.2 删除附件

```
DELETE /api/attachments/<attachment_id>
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_update` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| attachment_id | Integer | 是 | 附件ID，路径参数 |

#### 响应结果

```json
{
  "message": "附件删除成功"
}
```

### 4.3 下载附件

```
GET /api/attachments/<attachment_id>/download
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_read` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| attachment_id | Integer | 是 | 附件ID，路径参数 |

#### 响应结果

直接返回文件内容，带有适当的 Content-Type 和 Content-Disposition 头信息。

### 4.4 批量更新物料进出记录状态

```
PUT /api/material-transactions/batch-status
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_status_manage` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| ids | Array[Integer] | 是 | 记录ID列表 |
| status | String | 是 | 新状态，可选值：loading, arrived, stored, used |

#### 响应结果

```json
{
  "message": "成功更新 3 条记录的状态",
  "updated_ids": [1, 2, 3]
}
```

## 5. 前端交互建议

### 5.1 附件列表展示

在物料进出记录详情页面中，建议添加附件列表区域，显示以下信息：

- 文件名
- 文件类型（可使用图标表示）
- 文件大小
- 上传时间
- 上传人
- 文件描述
- 操作按钮（下载、删除）

### 5.2 附件上传界面

提供简洁的附件上传界面，包含以下元素：

- 文件选择控件
- 文件描述输入框
- 上传按钮
- 上传进度指示器

### 5.3 批量状态更新界面

在物料进出记录列表页面中，提供批量操作功能：

- 复选框选择多条记录
- 批量状态更新下拉菜单
- 操作确认对话框
- 操作结果反馈

## 6. 注意事项

1. **文件安全性**：
   - 系统会验证文件路径的安全性，防止路径遍历攻击
   - 上传文件会经过安全处理，生成唯一文件名

2. **权限控制**：
   - 用户只能操作其有权限的工厂的物料进出记录附件
   - 系统会在每个操作中检查用户权限

3. **文件管理**：
   - 删除附件时，系统会同时删除物理文件和数据库记录
   - 如果物理文件删除失败，系统会记录错误日志但仍会删除数据库记录

4. **批量状态更新**：
   - 批量更新状态时，系统会检查每条记录的权限
   - 如果用户对任何一条记录没有权限，整个操作将被拒绝
   - 状态只能按照定义的流程顺序进行转换：loading → arrived → stored → used