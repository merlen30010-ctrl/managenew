# 物料进出模块说明文档

## 1. 模块概述

物料进出模块用于管理工厂物料的进出记录，支持物料从装载、到达、入库到使用的全流程状态管理，并提供相应的权限控制和操作人员分配功能。

## 2. 数据结构

### 2.1 MaterialTransaction 模型

物料进出记录的核心数据模型，包含以下字段：

#### 基本信息字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| id | Integer | 主键ID |
| date | Date | 交易日期 |
| customer | String | 客户名称 |
| material_name | String | 物料名称 |
| factory_id | Integer | 工厂ID，外键关联 |
| contract_number | String | 合同编号 |
| transaction_type | String | 交易类型 |
| packaging | String | 包装方式 |
| vehicle_number | String | 车牌号 |
| shipped_quantity | Float | 发货数量 |
| received_quantity | Float | 接收数量 |
| water_content | Float | 水分含量 |
| zinc_content | Float | 锌含量 |
| lead_content | Float | 铅含量 |
| chlorine_content | Float | 氯含量 |
| fluorine_content | Float | 氟含量 |
| remarks | String | 备注 |

#### 状态管理字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| status | String | 状态（loading, arrived, stored, used） |
| editable | Boolean | 是否可编辑 |

#### 司机信息字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| driver_name | String | 司机姓名 |
| driver_phone | String | 司机电话 |
| driver_id_card | String | 司机身份证号 |

#### 状态时间字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| loading_time | DateTime | 装载时间 |
| arrival_time | DateTime | 到达时间 |
| storage_time | DateTime | 入库时间 |
| usage_time | DateTime | 使用时间 |

#### 操作人员字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| created_by | Integer | 创建人ID |
| loading_by | Integer | 装载操作人ID |
| arrival_by | Integer | 到达确认人ID |
| storage_by | Integer | 入库操作人ID |
| usage_by | Integer | 使用操作人ID |

#### 时间戳字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

## 3. 业务逻辑

### 3.1 状态流转

物料进出记录遵循以下状态流转规则：

```
loading (装载) → arrived (到达) → stored (入库) → used (已使用)
```

- 每个状态只能按照上述顺序进行转换，不允许跳过中间状态或回退到之前状态
- 每次状态变更时，会自动记录对应的时间和操作人员
- 当状态变为 `used` 时，记录将被标记为不可编辑

### 3.2 权限控制

模块包含以下权限控制：

- `material_transaction_status_manage`: 允许用户管理物料进出记录的状态
- `material_transaction_status_manage_all`: 允许用户管理所有工厂的物料进出记录状态

对于没有 `material_transaction_status_manage_all` 权限的用户，只能管理其负责工厂的物料进出记录。

### 3.3 可编辑性控制

- 默认情况下，新创建的记录是可编辑的
- 当记录状态变为 `used` 时，记录将被标记为不可编辑
- 不可编辑的记录无法被修改基本信息

## 4. API接口文档

### 4.1 获取物料进出记录列表

```
GET /api/material-transactions
```

#### 权限要求

- 需要用户登录

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| page | Integer | 否 | 页码，默认为1 |
| per_page | Integer | 否 | 每页记录数，默认为10 |
| factory_id | Integer | 否 | 工厂ID筛选 |
| start_date | String | 否 | 开始日期筛选 (YYYY-MM-DD) |
| end_date | String | 否 | 结束日期筛选 (YYYY-MM-DD) |
| customer | String | 否 | 客户名称筛选 |
| material_name | String | 否 | 物料名称筛选 |
| transaction_type | String | 否 | 交易类型筛选 |
| status | String | 否 | 状态筛选 |

#### 响应结果

```json
{
  "items": [
    {
      "id": 1,
      "date": "2023-01-01",
      "customer": "客户名称",
      "material_name": "物料名称",
      "factory_id": 1,
      "contract_number": "HT2023001",
      "transaction_type": "入库",
      "packaging": "袋装",
      "vehicle_number": "京A12345",
      "shipped_quantity": 100.0,
      "received_quantity": 98.5,
      "water_content": 5.2,
      "zinc_content": 0.5,
      "lead_content": 0.3,
      "chlorine_content": 0.1,
      "fluorine_content": 0.2,
      "remarks": "备注信息",
      "status": "loading",
      "editable": true,
      "driver_name": "张三",
      "driver_phone": "13800138000",
      "driver_id_card": "110101199001011234",
      "loading_time": "2023-01-01T08:00:00",
      "arrival_time": null,
      "storage_time": null,
      "usage_time": null,
      "created_by": 1,
      "loading_by": 2,
      "arrival_by": null,
      "storage_by": null,
      "usage_by": null,
      "created_at": "2023-01-01T07:30:00",
      "updated_at": "2023-01-01T08:00:00"
    }
  ],
  "total": 100,
  "page": 1,
  "per_page": 10,
  "pages": 10
}
```

### 4.2 获取单个物料进出记录

```
GET /api/material-transactions/<transaction_id>
```

#### 权限要求

- 需要用户登录

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_id | Integer | 是 | 记录ID，路径参数 |

#### 响应结果

```json
{
  "id": 1,
  "date": "2023-01-01",
  "customer": "客户名称",
  "material_name": "物料名称",
  "factory_id": 1,
  "contract_number": "HT2023001",
  "transaction_type": "入库",
  "packaging": "袋装",
  "vehicle_number": "京A12345",
  "shipped_quantity": 100.0,
  "received_quantity": 98.5,
  "water_content": 5.2,
  "zinc_content": 0.5,
  "lead_content": 0.3,
  "chlorine_content": 0.1,
  "fluorine_content": 0.2,
  "remarks": "备注信息",
  "status": "loading",
  "editable": true,
  "driver_name": "张三",
  "driver_phone": "13800138000",
  "driver_id_card": "110101199001011234",
  "loading_time": "2023-01-01T08:00:00",
  "arrival_time": null,
  "storage_time": null,
  "usage_time": null,
  "created_by": 1,
  "loading_by": 2,
  "arrival_by": null,
  "storage_by": null,
  "usage_by": null,
  "created_at": "2023-01-01T07:30:00",
  "updated_at": "2023-01-01T08:00:00"
}
```

### 4.3 创建物料进出记录

```
POST /api/material-transactions
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_create` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| date | String | 是 | 交易日期 (YYYY-MM-DD) |
| customer | String | 是 | 客户名称 |
| material_name | String | 是 | 物料名称 |
| factory_id | Integer | 是 | 工厂ID |
| contract_number | String | 否 | 合同编号 |
| transaction_type | String | 是 | 交易类型 |
| packaging | String | 否 | 包装方式 |
| vehicle_number | String | 否 | 车牌号 |
| shipped_quantity | Float | 否 | 发货数量 |
| received_quantity | Float | 否 | 接收数量 |
| water_content | Float | 否 | 水分含量 |
| zinc_content | Float | 否 | 锌含量 |
| lead_content | Float | 否 | 铅含量 |
| chlorine_content | Float | 否 | 氯含量 |
| fluorine_content | Float | 否 | 氟含量 |
| remarks | String | 否 | 备注 |
| driver_name | String | 否 | 司机姓名 |
| driver_phone | String | 否 | 司机电话 |
| driver_id_card | String | 否 | 司机身份证号 |

#### 响应结果

返回新创建的记录完整信息，格式同获取单个记录。

### 4.4 更新物料进出记录

```
PUT /api/material-transactions/<transaction_id>
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_update` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_id | Integer | 是 | 记录ID，路径参数 |
| date | String | 否 | 交易日期 (YYYY-MM-DD) |
| customer | String | 否 | 客户名称 |
| material_name | String | 否 | 物料名称 |
| factory_id | Integer | 否 | 工厂ID |
| contract_number | String | 否 | 合同编号 |
| transaction_type | String | 否 | 交易类型 |
| packaging | String | 否 | 包装方式 |
| vehicle_number | String | 否 | 车牌号 |
| shipped_quantity | Float | 否 | 发货数量 |
| received_quantity | Float | 否 | 接收数量 |
| water_content | Float | 否 | 水分含量 |
| zinc_content | Float | 否 | 锌含量 |
| lead_content | Float | 否 | 铅含量 |
| chlorine_content | Float | 否 | 氯含量 |
| fluorine_content | Float | 否 | 氟含量 |
| remarks | String | 否 | 备注 |
| driver_name | String | 否 | 司机姓名 |
| driver_phone | String | 否 | 司机电话 |
| driver_id_card | String | 否 | 司机身份证号 |

#### 响应结果

返回更新后的记录完整信息，格式同获取单个记录。

### 4.5 删除物料进出记录

```
DELETE /api/material-transactions/<transaction_id>
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_delete` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_id | Integer | 是 | 记录ID，路径参数 |

#### 响应结果

```json
{
  "message": "记录已删除"
}
```

### 4.6 更新物料进出记录状态

```
PUT /api/material-transactions/<transaction_id>/status
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_status_manage` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_id | Integer | 是 | 记录ID，路径参数 |
| status | String | 是 | 新状态，可选值：loading, arrived, stored, used |

#### 响应结果

返回更新后的记录完整信息，格式同获取单个记录。

### 4.7 批量更新物料进出记录状态

```
PUT /api/material-transactions/batch-status
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_status_manage` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_ids | Array[Integer] | 是 | 记录ID列表 |
| status | String | 是 | 新状态，可选值：loading, arrived, stored, used |

#### 响应结果

```json
{
  "updated": [1, 2, 3],
  "errors": [
    {
      "id": 4,
      "error": "无法从 loading 状态转换为 stored 状态"
    }
  ]
}
```

### 4.8 分配物料进出记录操作人员

```
PUT /api/material-transactions/<transaction_id>/assign
```

#### 权限要求

- 需要用户登录
- 需要 `material_transaction_status_manage` 权限

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| transaction_id | Integer | 是 | 记录ID，路径参数 |
| loading_by | Integer | 否 | 装载操作人ID |
| arrival_by | Integer | 否 | 到达确认人ID |
| storage_by | Integer | 否 | 入库操作人ID |
| usage_by | Integer | 否 | 使用操作人ID |

#### 响应结果

返回更新后的记录完整信息，格式同获取单个记录。

## 5. 前端交互建议

### 5.1 状态流转UI

建议前端实现一个状态流程图，清晰展示当前记录的状态和可能的下一步操作：

```
[装载] → [到达] → [入库] → [使用]
```

- 已完成的状态显示为绿色
- 当前状态显示为蓝色
- 未完成的状态显示为灰色

### 5.2 权限控制UI

- 对于没有相应权限的用户，隐藏或禁用状态更新按钮
- 对于不可编辑的记录，禁用编辑按钮并显示提示信息

### 5.3 批量操作

- 提供批量选择功能，允许用户选择多条记录进行状态更新
- 批量操作时，显示操作结果摘要，包括成功和失败的记录数量

## 6. 注意事项

1. 状态只能按照定义的流程顺序进行转换，不能跳过中间状态或回退
2. 当记录状态变为 `used` 时，记录将被标记为不可编辑
3. 用户只能管理其有权限的工厂的物料进出记录
4. 批量更新状态时，会逐个验证每条记录的状态转换是否有效，无效的转换会被记录在错误列表中
5. 每次状态变更时，会自动记录对应的时间和操作人员信息