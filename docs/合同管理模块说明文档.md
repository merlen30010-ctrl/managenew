# 合同管理模块说明文档

## 1. 模块概述

合同管理模块用于管理企业的各类合同，包括原料采购、辅料采购、产品销售等不同类型的合同。该模块支持合同基本信息的管理、合同文件的上传与管理、合同状态的跟踪以及操作日志的记录等功能。

## 2. 数据结构

### 2.1 Contract 模型

#### 基本信息字段

| 字段名 | 类型 | 说明 | 索引 |
| ------ | ---- | ---- | ---- |
| id | Integer | 主键 | 是 |
| contract_type | String(20) | 合同类型（原料采购、辅料采购、产品销售、其他） | 是 |
| contract_number | String(50) | 合同编号（唯一） | 是 |
| customer_id | Integer | 客户ID（外键关联customers表） | 是 |
| material_id | Integer | 物料ID（外键关联materials表） | 是 |
| factory_id | Integer | 分厂ID（外键关联departments表） | 是 |
| responsible_id | Integer | 负责人ID（外键关联users表） | 是 |
| sign_date | Date | 签订日期 | 是 |
| expiry_date | Date | 到期日期 | 是 |
| tax_rate | Float | 税率 | 否 |
| pricing_method | String(20) | 计价方式 | 是 |
| coefficient | Float | 系数 | 否 |
| status | String(20) | 合同状态（默认为"执行"） | 是 |

#### 特殊字段

| 字段名 | 类型 | 说明 | 索引 |
| ------ | ---- | ---- | ---- |
| is_tax_inclusive | Boolean | 是否含税 | 是 |
| is_invoice_received | Boolean | 是否收到发票 | 是 |
| operation_logs | Text | 操作日志（JSON格式） | 否 |

#### 时间戳字段

| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### 关联关系

- customer: 与Customer模型的一对多关系
- material: 与Material模型的一对多关系
- factory: 与Department模型的一对多关系
- responsible: 与User模型的一对多关系
- files: 与ContractFile模型的一对多关系

### 2.2 ContractFile 模型

| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | Integer | 主键 |
| contract_id | Integer | 合同ID（外键关联contracts表） |
| file_path | String(200) | 文件路径 |
| file_name | String(100) | 文件名 |
| file_type | String(10) | 文件类型 |
| created_at | DateTime | 创建时间 |

#### 关联关系

- contract: 与Contract模型的多对一关系

## 3. 业务逻辑

### 3.1 计价方式

合同模型支持多种计价方式，包括：

- weight: 金吨计价
- content: 含量加点
- processing: 加工费用
- gross_weight: 毛吨计价

系统提供了`calculate_price`方法，根据不同的计价方式和系数计算价格：

```python
def calculate_price(self, base_price, quantity):
    """根据计价方式和系数计算价格"""
    if self.coefficient is None:
        return base_price * quantity
        
    if self.pricing_method == 'weight':
        # 金吨计价：基础价格 + 系数
        return (base_price + self.coefficient) * quantity
    elif self.pricing_method == 'content':
        # 含量加点：基础价格 * (1 + 系数/100)
        return base_price * (1 + self.coefficient / 100) * quantity
    elif self.pricing_method == 'processing':
        # 加工费用：基础价格 + 系数
        return (base_price + self.coefficient) * quantity
    elif self.pricing_method == 'gross_weight':
        # 毛吨计价：基础价格 + 系数
        return (base_price + self.coefficient) * quantity
    else:
        return base_price * quantity
```

### 3.2 合同状态管理

合同状态主要包括：

- 执行：合同正在执行中
- 合同归档：合同已完成并归档

当合同状态为"合同归档"时，有特殊的权限控制：

- 只有超级管理员可以编辑已归档的合同
- 只有超级管理员可以删除已归档的合同
- 只有超级管理员可以上传或删除已归档合同的附件

### 3.3 操作日志记录

合同模型内置了操作日志记录功能，通过`append_log`方法记录各种操作：

```python
def append_log(self, action, actor_id=None, details=None):
    """追加一条操作日志，JSON格式存储在operation_logs
    action: 字符串，如 create/update/status_change/attachment_upload/attachment_delete
    actor_id: 执行人的用户ID
    details: 任意可JSON序列化的dict
    """
    entry = {
        'ts': datetime.utcnow().isoformat() + 'Z',
        'action': action,
        'actor_id': actor_id,
        'details': details or {}
    }
    logs = self._get_logs()
    logs.append(entry)
    self._set_logs(logs)
    return entry
```

系统会记录以下类型的操作日志：

- create: 创建合同
- update: 更新合同信息
- status_change: 合同状态变更
- attachment_upload: 上传合同附件
- attachment_delete: 删除合同附件

### 3.4 文件管理

合同模块支持文件上传、下载、预览和删除功能：

- 文件上传：支持在创建合同时上传文件，或者为现有合同上传文件
- 文件下载：支持下载已上传的合同文件
- 文件预览：支持预览PDF、图片等格式的文件
- 文件删除：支持删除已上传的合同文件

对于Word文档（.doc, .docx），系统会尝试自动转换为PDF格式以便于在线预览。

## 4. API接口文档

### 4.1 获取合同列表

- **URL**: `/api/contracts`
- **方法**: GET
- **权限要求**: `contract_read`
- **请求参数**: 无
- **响应结果**:
  ```json
  [
    {
      "id": 1,
      "contract_type": "原料采购",
      "contract_number": "CG-2023-001",
      "customer_id": 1,
      "material_id": 2,
      "factory_id": 3,
      "responsible_id": 4,
      "sign_date": "2023-01-01",
      "expiry_date": "2023-12-31",
      "tax_rate": 13.0,
      "pricing_method": "weight",
      "coefficient": 10.5,
      "status": "执行",
      "is_tax_inclusive": true,
      "is_invoice_received": false
    },
    // 更多合同...
  ]
  ```

### 4.2 获取单个合同

- **URL**: `/api/contracts/<int:contract_id>`
- **方法**: GET
- **权限要求**: `contract_read`
- **请求参数**: 无
- **响应结果**:
  ```json
  {
    "id": 1,
    "contract_type": "原料采购",
    "contract_number": "CG-2023-001",
    "customer_id": 1,
    "material_id": 2,
    "factory_id": 3,
    "responsible_id": 4,
    "sign_date": "2023-01-01",
    "expiry_date": "2023-12-31",
    "tax_rate": 13.0,
    "pricing_method": "weight",
    "coefficient": 10.5,
    "status": "执行",
    "is_tax_inclusive": true,
    "is_invoice_received": false,
    "operation_logs": [
      {
        "ts": "2023-01-01T08:00:00Z",
        "action": "create",
        "actor_id": 1,
        "details": {...}
      },
      // 更多日志...
    ]
  }
  ```

### 4.3 创建合同

- **URL**: `/api/contracts`
- **方法**: POST
- **权限要求**: `contract_create`
- **请求参数**:
  ```json
  {
    "contract_type": "原料采购",
    "contract_number": "CG-2023-001",
    "customer_id": 1,
    "material_id": 2,
    "factory_id": 3,
    "responsible_id": 4,
    "sign_date": "2023-01-01",
    "expiry_date": "2023-12-31",
    "tax_rate": 13.0,
    "pricing_method": "weight",
    "coefficient": 10.5,
    "status": "执行",
    "is_tax_inclusive": true,
    "is_invoice_received": false
  }
  ```
- **响应结果**:
  ```json
  {
    "id": 1,
    "contract_type": "原料采购",
    "contract_number": "CG-2023-001",
    "customer_id": 1,
    "material_id": 2,
    "factory_id": 3,
    "responsible_id": 4,
    "sign_date": "2023-01-01",
    "expiry_date": "2023-12-31",
    "tax_rate": 13.0,
    "pricing_method": "weight",
    "coefficient": 10.5,
    "status": "执行",
    "is_tax_inclusive": true,
    "is_invoice_received": false
  }
  ```

### 4.4 更新合同

- **URL**: `/api/contracts/<int:contract_id>`
- **方法**: PUT
- **权限要求**: `contract_update`
- **请求参数**: 与创建合同相同，但字段可以部分提供
- **特殊限制**:
  - 合同归档后只有超级管理员可以编辑
  - `is_tax_inclusive`和`is_invoice_received`字段只有超级管理员可以修改
  - 合同状态变更为"合同归档"或从"合同归档"变更只有超级管理员可以操作
- **响应结果**: 与创建合同相同

### 4.5 删除合同

- **URL**: `/api/contracts/<int:contract_id>`
- **方法**: DELETE
- **权限要求**: `contract_delete`
- **特殊限制**: 合同归档后只有超级管理员可以删除
- **响应结果**:
  ```json
  {
    "message": "合同删除成功"
  }
  ```

## 5. 前端交互建议

### 5.1 合同列表页面

- 提供合同类型、状态、客户等多维度筛选
- 显示合同的关键信息：合同编号、客户、物料、签订日期、到期日期、状态等
- 提供操作按钮：查看详情、编辑、删除、上传附件等

### 5.2 合同详情页面

- 显示合同的所有信息
- 显示合同的操作日志
- 显示合同的附件列表，提供下载、预览、删除功能
- 提供编辑、删除、上传附件等操作按钮

### 5.3 合同创建/编辑页面

- 提供表单填写合同信息
- 提供客户、物料、分厂、负责人等下拉选择
- 提供文件上传功能

## 6. 注意事项

1. **合同编号唯一性**：系统会检查合同编号的唯一性，创建或更新合同时需确保合同编号不重复。

2. **日期格式**：API接口中的日期字段需要使用ISO格式（YYYY-MM-DD）。

3. **权限控制**：
   - 读取合同需要`contract_read`权限
   - 创建合同需要`contract_create`权限
   - 更新合同需要`contract_update`权限
   - 删除合同需要`contract_delete`权限

4. **归档合同的特殊处理**：
   - 归档合同的编辑、删除、附件上传/删除操作仅限超级管理员
   - 合同归档状态的变更仅限超级管理员

5. **文件安全性**：
   - 系统会验证文件路径的安全性，防止路径遍历攻击
   - 文件上传会自动创建目录结构并生成唯一文件名

6. **Word转PDF**：
   - 系统会尝试将上传的Word文档自动转换为PDF格式以便于在线预览
   - 转换成功后会同时保存原始Word文档和转换后的PDF文档