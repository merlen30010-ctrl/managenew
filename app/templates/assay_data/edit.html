{% extends "base.html" %}

{% block title %}编辑化验数据{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">编辑化验数据</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div class="form-group">
                            <label for="sample_name">样品名称 *</label>
                            <input type="text" class="form-control" id="sample_name" name="sample_name" value="{{ assay_data.sample_name }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="factory_id">分厂 *</label>
                            <select class="form-control" id="factory_id" name="factory_id" required>
                                <option value="">请选择分厂</option>
                                {% for factory in factories %}
                                <option value="{{ factory.id }}" {% if factory.id == assay_data.factory_id %}selected{% endif %}>
                                    {{ factory.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 常用指标 -->
                        <h4>常用指标</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="water_content">水含量</label>
                                    <input type="number" class="form-control" id="water_content" name="water_content" 
                                           value="{{ assay_data.water_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="zinc_content">锌含量</label>
                                    <input type="number" class="form-control" id="zinc_content" name="zinc_content" 
                                           value="{{ assay_data.zinc_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="lead_content">铅含量</label>
                                    <input type="number" class="form-control" id="lead_content" name="lead_content" 
                                           value="{{ assay_data.lead_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="chlorine_content">氯含量</label>
                                    <input type="number" class="form-control" id="chlorine_content" name="chlorine_content" 
                                           value="{{ assay_data.chlorine_content or 0 }}" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 其他指标 -->
                        <h4>其他指标</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="fluorine_content">氟含量</label>
                                    <input type="number" class="form-control" id="fluorine_content" name="fluorine_content" 
                                           value="{{ assay_data.fluorine_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="iron_content">铁含量</label>
                                    <input type="number" class="form-control" id="iron_content" name="iron_content" 
                                           value="{{ assay_data.iron_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="silicon_content">硅含量</label>
                                    <input type="number" class="form-control" id="silicon_content" name="silicon_content" 
                                           value="{{ assay_data.silicon_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="sulfur_content">硫含量</label>
                                    <input type="number" class="form-control" id="sulfur_content" name="sulfur_content" 
                                           value="{{ assay_data.sulfur_content or 0 }}" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="high_heat">高热值</label>
                                    <input type="number" class="form-control" id="high_heat" name="high_heat" 
                                           value="{{ assay_data.high_heat or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="low_heat">低热值</label>
                                    <input type="number" class="form-control" id="low_heat" name="low_heat" 
                                           value="{{ assay_data.low_heat or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="silver_content">银含量</label>
                                    <input type="number" class="form-control" id="silver_content" name="silver_content" 
                                           value="{{ assay_data.silver_content or 0 }}" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="recovery_rate">回收率</label>
                                    <input type="number" class="form-control" id="recovery_rate" name="recovery_rate" 
                                           value="{{ assay_data.recovery_rate or 0 }}" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 备注 -->
                        <div class="form-group">
                            <label for="remarks">备注</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3">{{ assay_data.remarks or '' }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">保存</button>
                        <a href="{{ url_for('assay_data.list_assay_data') }}" class="btn btn-secondary">取消</a>
                    </form>
                    
                    <!-- 附件上传和预览 -->
                    <hr>
                    <h4>附件管理</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">上传附件</h5>
                                </div>
                                <div class="card-body">
                                    <form id="attachmentForm" enctype="multipart/form-data">
                                        <div class="form-group">
                                            <label for="attachmentFile">选择图片文件</label>
                                            <input type="file" class="form-control-file" id="attachmentFile" accept="image/*">
                                            <small class="form-text text-muted">支持格式：jpg, jpeg, png, gif</small>
                                        </div>
                                        <button type="button" class="btn btn-info" onclick="uploadAttachment({{ assay_data.id }})">上传</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">附件列表</h5>
                                </div>
                                <div class="card-body">
                                    <div id="attachmentList">
                                        <!-- 附件列表将通过JavaScript动态加载 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function uploadAttachment(assayDataId) {
    const fileInput = document.getElementById('attachmentFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('请选择要上传的文件');
        return;
    }
    
    // 检查文件类型
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        alert('只允许上传图片文件（jpg, jpeg, png, gif）');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('assay_data_id', assayDataId);
    
    fetch('/assay-attachment/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('上传失败：' + data.error);
        } else {
            alert('上传成功');
            loadAttachments(assayDataId);
            // 清空文件选择
            fileInput.value = '';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('上传失败：' + error.message);
    });
}

function loadAttachments(assayDataId) {
    fetch(`/assay-attachment/assay-data/${assayDataId}`)
    .then(response => response.json())
    .then(data => {
        const attachmentList = document.getElementById('attachmentList');
        if (data.attachments && data.attachments.length > 0) {
            attachmentList.innerHTML = '<ul class="list-group">';
            data.attachments.forEach(attachment => {
                attachmentList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="/assay-attachment/${attachment.id}/preview" target="_blank">${attachment.original_name}</a>
                            <small class="text-muted">(${(attachment.file_size/1024).toFixed(2)} KB)</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteAttachment(${attachment.id}, ${assayDataId})">删除</button>
                    </li>
                `;
            });
            attachmentList.innerHTML += '</ul>';
        } else {
            attachmentList.innerHTML = '<p class="text-muted">暂无附件</p>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('attachmentList').innerHTML = '<p class="text-danger">加载附件列表失败</p>';
    });
}

function deleteAttachment(attachmentId, assayDataId) {
    if (confirm('确定要删除这个附件吗？')) {
        fetch(`/assay-attachment/${attachmentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('删除失败：' + data.error);
            } else {
                alert('删除成功');
                loadAttachments(assayDataId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败：' + error.message);
        });
    }
}

// 页面加载时获取附件列表
document.addEventListener('DOMContentLoaded', function() {
    loadAttachments({{ assay_data.id }});
});
</script>
{% endblock %}